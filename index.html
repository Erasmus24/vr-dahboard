<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Analytics Lab</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #ui-panel { position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; z-index: 10; }
        button, input { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <a-scene>
        <a-sky color="#6EBAA7"></a-sky>
        <a-plane position="0 0 -5" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
        <a-entity id="chart" position="0 1.5 -3"></a-entity>
        <a-camera position="0 1.6 0"><a-cursor></a-cursor></a-camera>
        <a-light type="ambient" color="#445"></a-light>
        <a-light type="point" intensity="1" position="2 4 4"></a-light>
    </a-scene>
    <div id="ui-panel">
        <input type="file" id="dataUpload" accept=".csv">
        <button onclick="renderChart('bar')">Bar Chart</button>
        <button onclick="renderChart('scatter')">Scatter Plot</button>
        <button onclick="runML()">Run Machine Learning</button>
    </div>
    <script>
        console.log("Script loaded");
        let dataset = [
            { month: "Jan", sales: 1200, revenue: 24000 },
            { month: "Feb", sales: 1500, revenue: 30000 },
            { month: "Mar", sales: 1800, revenue: 36000 },
            { month: "Apr", sales: 1400, revenue: 28000 },
            { month: "May", sales: 2000, revenue: 40000 }
        ];

        document.getElementById('dataUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    complete: (result) => {
                        dataset = result.data.map(row => ({
                            month: row.month || row.Month || row.year || row.Year || '',
                            sales: parseFloat(row.sales || row.Sales || row.gdp || row.GDP || 0),
                            revenue: parseFloat(row.revenue || row.Revenue || row.trade || row.Trade || 0)
                        })).filter(row => row.month && row.sales && row.revenue);
                        console.log("Dataset updated:", dataset);
                        renderChart('bar');
                    },
                    error: (error) => console.error("CSV parse error:", error)
                });
            }
        });

        function renderChart(type) {
            console.log(`Button clicked: Rendering ${type} chart`);
            const chartEntity = document.getElementById('chart');
            chartEntity.innerHTML = '';
            const chartGroup = document.createElement('a-entity');
            chartGroup.setAttribute('position', '0 0 0');
            chartEntity.appendChild(chartGroup);

            const maxItems = Math.min(dataset.length, 20); // Limit for performance
            const spacing = maxItems > 1 ? 0.5 : 0;
            const offset = (maxItems - 1) * spacing / 2;

            if (type === 'bar') {
                dataset.slice(0, maxItems).forEach((data, index) => {
                    const bar = document.createElement('a-box');
                    const height = Math.max(data.sales / 500, 0.1); // Prevent zero height
                    bar.setAttribute('position', `${index * spacing - offset} ${height / 2} 0`);
                    bar.setAttribute('width', '0.4');
                    bar.setAttribute('height', height);
                    bar.setAttribute('depth', '0.4');
                    bar.setAttribute('color', `hsl(${index * 360 / maxItems}, 70%, 50%)`);
                    chartGroup.appendChild(bar);

                    const label = document.createElement('a-text');
                    label.setAttribute('value', data.month);
                    label.setAttribute('position', `${index * spacing - offset} -0.2 0`);
                    label.setAttribute('align', 'center');
                    label.setAttribute('color', 'white');
                    chartGroup.appendChild(label);
                });
            } else if (type === 'scatter') {
                dataset.slice(0, maxItems).forEach((data, index) => {
                    const point = document.createElement('a-sphere');
                    const x = index * spacing - offset;
                    const y = Math.max(data.sales / 500, 0.1);
                    const z = data.revenue / 10000;
                    point.setAttribute('position', `${x} ${y} ${z}`);
                    point.setAttribute('radius', '0.1');
                    point.setAttribute('color', `hsl(${index * 360 / maxItems}, 70%, 50%)`);
                    chartGroup.appendChild(point);

                    const label = document.createElement('a-text');
                    label.setAttribute('value', data.month);
                    label.setAttribute('position', `${x} ${y - 0.2} ${z}`);
                    label.setAttribute('align', 'center');
                    label.setAttribute('color', 'white');
                    chartGroup.appendChild(label);
                });
            }
        }

        async function runML() {
            console.log("Button clicked: Running ML");
            if (dataset.length < 2) {
                alert("Insufficient data for ML. Upload a dataset with at least 2 rows.");
                return;
            }

            const xs = dataset.map((_, i) => i);
            const ys = dataset.map(d => d.sales);

            const model = tf.sequential();
            model.add(tf.layers.dense({ units: 1, inputShape: [1] }));
            model.compile({ optimizer: 'sgd', loss: 'meanSquaredError' });

            const xsTensor = tf.tensor2d(xs, [xs.length, 1]);
            const ysTensor = tf.tensor2d(ys, [ys.length, 1]);

            await model.fit(xsTensor, ysTensor, { epochs: 100 });

            const predictions = model.predict(tf.tensor2d(xs, [xs.length, 1])).dataSync();

            const chartEntity = document.getElementById('chart');
            const maxItems = Math.min(dataset.length, 20);
            const spacing = maxItems > 1 ? 0.5 : 0;
            const offset = (maxItems - 1) * spacing / 2;
            const line = document.createElement('a-entity');
            line.setAttribute('line', `start: -${offset} ${predictions[0] / 500} 0; end: ${offset} ${predictions[predictions.length - 1] / 500} 0; color: red`);
            chartEntity.appendChild(line);

            alert('Linear regression applied! Red line shows predicted sales trend.');
        }

        renderChart('bar');
    </script>
</body>
</html>