<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Analytics Lab</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #ui-panel { position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; z-index: 10; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <!-- A-Frame Scene -->
    <a-scene>
        <!-- Assets -->
        <a-assets>
            <img id="skyTexture" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg">
            <a-asset-item id="labModel" src="https://cdn.glitch.com/1e0b0b5a-4b1e-4b0a-8b8b-6b6b6b6b6b6b%2Flab.glb"></a-asset-item>
        </a-assets>

        <!-- Sky -->
        <a-sky src="#skyTexture"></a-sky>

        <!-- Lab Environment -->
        <a-entity gltf-model="#labModel" position="0 0 -5" scale="2 2 2"></a-entity>

        <!-- 3D Chart (Populated via JS) -->
        <a-entity id="chart" position="0 1.5 -3"></a-entity>

        <!-- Control Panel in VR -->
        <a-entity id="control-panel" position="-2 1.5 -2" rotation="0 45 0">
            <a-plane width="1.5" height="1" color="#333" material="opacity: 0.8">
                <a-text value="Analytics Lab" align="center" position="0 0.4 0.01" color="white" width="1.2"></a-text>
                <a-entity id="btn-bar" geometry="primitive: plane; width: 0.4; height: 0.15" material="color: #007bff" position="-0.5 0 0.01">
                    <a-text value="Bar Chart" align="center" color="white" width="0.35" scale="0.8 0.8 0.8"></a-text>
                </a-entity>
                <a-entity id="btn-scatter" geometry="primitive: plane; width: 0.4; height: 0.15" material="color: #007bff" position="0 0 0.01">
                    <a-text value="Scatter Plot" align="center" color="white" width="0.35" scale="0.8 0.8 0.8"></a-text>
                </a-entity>
                <a-entity id="btn-ml" geometry="primitive: plane; width: 0.4; height: 0.15" material="color: #28a745" position="0.5 0 0.01">
                    <a-text value="Run ML" align="center" color="white" width="0.35" scale="0.8 0.8 0.8"></a-text>
                </a-entity>
            </a-plane>
        </a-entity>

        <!-- VR Camera with Hand Controls -->
        <a-camera position="0 1.6 0">
            <a-cursor></a-cursor>
            <a-entity hand-controls="hand: left"></a-entity>
            <a-entity hand-controls="hand: right"></a-entity>
        </a-camera>

        <!-- Lighting -->
        <a-light type="ambient" color="#445"></a-light>
        <a-light type="point" intensity="1" position="2 4 4"></a-light>
    </a-scene>

    <!-- 2D UI for Non-VR Users -->
    <div id="ui-panel">
        <button onclick="renderChart('bar')">Bar Chart</button>
        <button onclick="renderChart('scatter')">Scatter Plot</button>
        <button onclick="runML()">Run Machine Learning</button>
    </div>

    <script>
        // Sample Dataset (Sales Data)
        const dataset = [
            { month: "Jan", sales: 1200, revenue: 24000 },
            { month: "Feb", sales: 1500, revenue: 30000 },
            { month: "Mar", sales: 1800, revenue: 36000 },
            { month: "Apr", sales: 1400, revenue: 28000 },
            { month: "May", sales: 2000, revenue: 40000 }
        ];

        // Chart Rendering
        function renderChart(type) {
            const chartEntity = document.getElementById('chart');
            chartEntity.innerHTML = ''; // Clear previous chart

            const scene = document.querySelector('a-scene');
            const chartGroup = document.createElement('a-entity');
            chartGroup.setAttribute('position', '0 0 0');
            chartEntity.appendChild(chartGroup);

            if (type === 'bar') {
                dataset.forEach((data, index) => {
                    const bar = document.createElement('a-box');
                    const height = data.sales / 500;
                    bar.setAttribute('position', `${index * 0.5 - 1} ${height / 2} 0`);
                    bar.setAttribute('width', '0.4');
                    bar.setAttribute('height', height);
                    bar.setAttribute('depth', '0.4');
                    bar.setAttribute('color', `hsl(${index * 60}, 70%, 50%)`);
                    chartGroup.appendChild(bar);

                    // Label
                    const label = document.createElement('a-text');
                    label.setAttribute('value', data.month);
                    label.setAttribute('position', `${index * 0.5 - 1} -0.2 0`);
                    label.setAttribute('align', 'center');
                    label.setAttribute('color', 'white');
                    chartGroup.appendChild(label);
                });
            } else if (type === 'scatter') {
                dataset.forEach((data, index) => {
                    const point = document.createElement('a-sphere');
                    const x = index * 0.5 - 1;
                    const y = data.sales / 500;
                    const z = data.revenue / 10000;
                    point.setAttribute('position', `${x} ${y} ${z}`);
                    point.setAttribute('radius', '0.1');
                    point.setAttribute('color', `hsl(${index * 60}, 70%, 50%)`);
                    chartGroup.appendChild(point);

                    // Label
                    const label = document.createElement('a-text');
                    label.setAttribute('value', data.month);
                    label.setAttribute('position', `${x} ${y - 0.2} ${z}`);
                    label.setAttribute('align', 'center');
                    label.setAttribute('color', 'white');
                    chartGroup.appendChild(label);
                });
            }
        }

        // Machine Learning (Linear Regression with TensorFlow.js)
        async function runML() {
            const xs = dataset.map((_, i) => i);
            const ys = dataset.map(d => d.sales);

            const model = tf.sequential();
            model.add(tf.layers.dense({ units: 1, inputShape: [1] }));
            model.compile({ optimizer: 'sgd', loss: 'meanSquaredError' });

            const xsTensor = tf.tensor2d(xs, [xs.length, 1]);
            const ysTensor = tf.tensor2d(ys, [ys.length, 1]);

            await model.fit(xsTensor, ysTensor, { epochs: 100 });

            // Predict for visualization
            const predictions = model.predict(tf.tensor2d(xs, [xs.length, 1])).dataSync();
            
            // Add regression line to chart
            const chartEntity = document.getElementById('chart');
            const line = document.createElement('a-entity');
            line.setAttribute('line', `start: -1 ${predictions[0] / 500} 0; end: 1 ${predictions[predictions.length - 1] / 500} 0; color: red`);
            chartEntity.appendChild(line);

            alert('Linear regression applied! Red line shows predicted sales trend.');
        }

        // VR Interaction
        document.getElementById('btn-bar').addEventListener('click', () => renderChart('bar'));
        document.getElementById('btn-scatter').addEventListener('click', () => renderChart('scatter'));
        document.getElementById('btn-ml').addEventListener('click', runML);

        // Initial Chart
        renderChart('bar');
    </script>
</body>
</html>